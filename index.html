<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ””ì½”ì¸ ì•ŒëŒë©ğŸ””</title>
  <style>
    body { font-family:sans-serif; background:#f4f4f4; padding:20px }
    .card { background:#fff; border-radius:12px; padding:20px; max-width:400px; margin:0 auto; box-shadow:0 4px 12px rgba(0,0,0,0.1) }
    h1 { text-align:center; color:#7b5cff }
    label { display:block; margin:12px 0 4px; font-weight:bold }
    select,input[type=number],input[type=file] { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px }
    #price { margin:16px 0; font-size:1.2em; font-weight:bold }
    button { width:100%; padding:12px; background:#7b5cff; color:#fff; border:none; border-radius:8px; font-size:1em; margin-top:16px }
    .alarms { margin-top:20px }
    .alarm-item { background:#f9f9f9; padding:10px; margin-top:8px; border-radius:8px; display:flex; justify-content:space-between; }
    .alarm-item button { background:#ff5c5c; border:none; color:#fff; padding:6px 12px; border-radius:6px }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ””ì½”ì¸ ì•ŒëŒë©ğŸ””</h1>

    <label for="exchange">ê±°ë˜ì†Œ ì„ íƒ</label>
    <select id="exchange">
      <option value="upbit">ì—…ë¹„íŠ¸</option>
      <option value="binance">ë°”ì´ë‚¸ìŠ¤</option>
      <option value="bitget">ë¹„íŠ¸ê²Ÿ</option>
    </select>

    <label for="coin">ì½”ì¸ ì„ íƒ</label>
    <select id="coin">
      <option value="BTC">ë¹„íŠ¸ì½”ì¸ (BTC)</option>
      <option value="ETH">ì´ë”ë¦¬ì›€ (ETH)</option>
      <option value="SOL">ì†”ë¼ë‚˜ (SOL)</option>
      <option value="XRP">ë¦¬í”Œ (XRP)</option>
      <option value="ADA">ì—ì´ë‹¤ (ADA)</option>
      <option value="DOGE">ë„ì§€ (DOGE)</option>
      <option value="AVAX">ì•„ë°œë€ì²´ (AVAX)</option>
    </select>

    <div id="price">í˜„ì¬ê°€: -</div>

    <label for="threshold">ì„¤ì •ê°€</label>
    <input type="number" id="threshold" placeholder="ì˜ˆ: 30000"/>

    <label for="condition">ì•Œë¦¼ ì¡°ê±´</label>
    <select id="condition">
      <option value="above">ì„¤ì •ê°€ ì´ìƒ ë„ë‹¬ ì‹œ</option>
      <option value="below">ì„¤ì •ê°€ ì´í•˜ ë„ë‹¬ ì‹œ</option>
    </select>

    <label for="interval">ë°˜ë³µ ê°„ê²© (ì´ˆ)</label>
    <input type="number" id="interval" value="2"/>

    <label for="sound">ì•Œë¦¼ ì‚¬ìš´ë“œ</label>
    <select id="sound">
      <option value="default">ğŸ”” ê¸°ë³¸ ë²¨ì†Œë¦¬</option>
      <option value="beep">ğŸ”‰ ë¹„í”„ ì†Œë¦¬</option>
      <option value="chime">ğŸµ ì°¨ì„ ì†Œë¦¬</option>
      <option value="custom">â• ì»¤ìŠ¤í…€ (.mp3)</option>
    </select>
    <input type="file" id="customFile" accept="audio/mp3" style="display:none; margin-top:8px;"/>

    <button id="register">ë“±ë¡</button>

    <div class="alarms" id="alarmsList"></div>
  </div>

  <script>
    const exchangeSel = document.getElementById('exchange');
    const coinSel     = document.getElementById('coin');
    const priceDiv    = document.getElementById('price');
    const threshold   = document.getElementById('threshold');
    const condition   = document.getElementById('condition');
    const intervalIn  = document.getElementById('interval');
    const soundSel    = document.getElementById('sound');
    const customFile  = document.getElementById('customFile');
    const registerBtn = document.getElementById('register');
    const alarmsList  = document.getElementById('alarmsList');
    let alarms = [];

    // ì»¤ìŠ¤í…€ íŒŒì¼ í† ê¸€
    soundSel.addEventListener('change', ()=>{
      customFile.style.display = soundSel.value==='custom' ? 'block' : 'none';
    });

    // ê°€ê²© fetch (2ì´ˆë§ˆë‹¤ + ì„ íƒ ë°”ê¿€ ë•Œ ë°”ë¡œ)
    async function fetchPrice(){
      const ex = exchangeSel.value;
      const sym = coinSel.value;
      let url;
      // ëª¨ë‘ í”„ë¡ì‹œë¡œ CORS í•´ê²°
      if(ex==='upbit'){
        url = `https://api.codetabs.com/v1/proxy?quest=https://api.upbit.com/v1/ticker?markets=KRW-${sym}`;
      }
      if(ex==='binance'){
        url = `https://api.codetabs.com/v1/proxy?quest=https://api.binance.com/api/v3/ticker/price?symbol=${sym}USDT`;
      }
      if(ex==='bitget'){
        url = `https://api.codetabs.com/v1/proxy?quest=https://api.bitget.com/api/spot/v1/market/ticker?symbol=${sym}USDT`;
      }
      try {
        const res = await fetch(url);
        const data = await res.json();
        let p;
        if(ex==='upbit')     p = data[0].trade_price;
        if(ex==='binance')   p = parseFloat(data.price);
        if(ex==='bitget')    p = parseFloat(data.data.last);
        const unit = ex==='upbit'?'KRW':'USDT';
        priceDiv.textContent = `í˜„ì¬ê°€: ${p.toLocaleString(undefined,{minimumFractionDigits: ex==='upbit'?0:2 })} ${unit}`;
        checkAlarms(p);
      } catch(err){
        priceDiv.textContent = 'í˜„ì¬ê°€: - (ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨)';
      }
    }

    // ì•ŒëŒ ì²´í¬
    function checkAlarms(p){
      alarms.forEach(a=>{
        if(a.triggered) return;
        if((a.condition==='above'&&p>=a.threshold)||(a.condition==='below'&&p<=a.threshold)){
          a.triggered = true;
          playSound(a);
          alert(`${a.coin} ${a.condition==='above'?'ì´ìƒ':'ì´í•˜'} ${a.threshold} ë„ë‹¬!`);
        }
      });
    }

    // ì‚¬ìš´ë“œ ì¬ìƒ
    function playSound(a){
      if(a.sound==='default') new Audio('bell.mp3').play();
      else if(a.sound==='beep')  new Audio('beep.mp3').play();
      else if(a.sound==='chime') new Audio('chime.mp3').play();
      else if(a.sound==='custom'&&a.file) new Audio(URL.createObjectURL(a.file)).play();
    }

    // ì•ŒëŒ ë“±ë¡
    registerBtn.addEventListener('click', ()=>{
      const alarm = {
        exchange: exchangeSel.value,
        coin:      coinSel.value,
        threshold: parseFloat(threshold.value),
        condition: condition.value,
        intervalSec: parseInt(intervalIn.value,10),
        sound:     soundSel.value,
        file:      customFile.files[0]||null,
        triggered: false
      };
      alarms.push(alarm);
      renderAlarms();
    });

    // ë¦¬ìŠ¤íŠ¸ ë Œë”
    function renderAlarms(){
      alarmsList.innerHTML = '';
      alarms.forEach((a,i)=>{
        const div = document.createElement('div');
        div.className = 'alarm-item';
        div.innerHTML = `
          <span>${a.coin} ${a.condition==='above'?'â–²':'â–¼'} ${a.threshold}</span>
          <button data-i="${i}">ì‚­ì œ</button>`;
        div.querySelector('button').addEventListener('click', e=>{
          alarms.splice(e.target.dataset.i,1);
          renderAlarms();
        });
        alarmsList.appendChild(div);
      });
    }

    // 2ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
    setInterval(fetchPrice, 2000);
    // ê±°ë˜ì†Œë‚˜ ì½”ì¸ ë³€ê²½ ì‹œ ì¦‰ì‹œ ê°±ì‹ 
    exchangeSel.addEventListener('change', fetchPrice);
    coinSel.addEventListener('change', fetchPrice);
    window.addEventListener('load', fetchPrice);
  </script>
</body>
</html>
